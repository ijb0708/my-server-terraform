- name: Join K3s Worker Node
  hosts: worker
  become: true

  vars:
    k3s_url: "https://master.kubernet.internal:6443" # 마스터 주소
    k3s_token: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39343863333230623439393663616137643338363836363136336463643332623237373264383065
      3565346338663864616234326137316337646236396235360a656432613932396330613965656230
      38353161336135376464356435336263626364666161353234373937346461313964353634383131
      6237653537353634380a353564356264383866346433663035313339393832646530323534353466
      31346361323566626265656265373361353533626437383065333932393166313832346433643034
      64663061323664616462616464663436336162633239316262383034343633656339656131363265
      30303334353638306363623833316539376461623663353836353037396636313666313961343136
      30333863356637303066356139656465376339363331616466343133623734366536373630623233
      63323733323031326233383437636166363637303534643966303965646638633064

  tasks:
    - name: Test SSH connection with password
      ping:
      register: ssh_ping_result
      ignore_errors: false # 실패 시 전체 플레이북 중단

    - name: Install dependencies
      apt:
        name:
          - curl
          - ca-certificates
        state: present
        update_cache: true

    - name: Join K3s cluster as worker
      shell: |
        curl -sfL https://get.k3s.io | K3S_URL={{ k3s_url }} K3S_TOKEN={{ k3s_token }} sh -
      args:
        creates: /etc/systemd/system/k3s-agent.service

    - name: Wait for k3s-agent to be active
      shell: systemctl is-active k3s-agent
      register: agent_status
      retries: 10
      delay: 5
      until: agent_status.stdout == "active"
